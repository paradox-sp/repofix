name: EthSign to SideStore (Limited)

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

jobs:
  convert-repo:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests pytz

      - name: Convert to SideStore format (10 apps only)
        run: |
          python <<EOF
          import requests
          import json
          from datetime import datetime, timezone
          import pytz

          # Configuration
          SOURCE_URL = "https://repo.ethsign.fyi/"
          REPO_IDENTIFIER = "fyi.ethsign.repo"
          DEFAULT_ICON = "https://paradoxtime.tk/img/pdt_logo_nobg_shadow.png"
          MAX_APPS = 10  # Safety limit to prevent crashes

          # Fetch source
          print("üîÑ Fetching EthSign repo (first 10 apps only)...")
          try:
              response = requests.get(SOURCE_URL, timeout=15)
              response.raise_for_status()
              src_data = response.json()
          except Exception as e:
              print(f"‚ùå Error fetching source: {e}")
              exit(1)

          # Transform to SideStore format
          output = {
              "name": "EthSign Apps (10 Sample)",
              "identifier": REPO_IDENTIFIER,
              "sourceURL": "https://raw.githubusercontent.com/paradox-sp/repofix/main/sidestore-source.json",
              "iconURL": DEFAULT_ICON,
              "userinfo": {},
              "apps": []
          }

          # Process only first 10 valid apps
          processed_count = 0
          for app in src_data.get("apps", []):
              if processed_count >= MAX_APPS:
                  break
              
              if not all(k in app for k in ["name", "bundleIdentifier", "version", "downloadURL"]):
                  continue

              # Get proper ISO 8601 timestamp
              now = datetime.now(timezone.utc).astimezone().isoformat()

              # Build minimal required version entry
              version_entry = {
                  "version": app["version"],
                  "date": app.get("versionDate", now),
                  "downloadURL": app["downloadURL"],
                  "size": app.get("size", 0),
                  "absoluteVersion": app["version"]
              }

              # Build minimal required app entry
              app_entry = {
                  "name": app["name"],
                  "bundleIdentifier": app["bundleIdentifier"],
                  "developerName": app.get("developerName", "Unknown"),
                  "version": app["version"],
                  "versionDate": app.get("versionDate", now),
                  "downloadURL": app["downloadURL"],
                  "localizedDescription": app.get("localizedDescription", "App from EthSign"),
                  "iconURL": app.get("iconURL", DEFAULT_ICON),
                  "size": app.get("size", 0),
                  "absoluteVersion": app["version"],
                  "appID": app["bundleIdentifier"],  # Critical: must match bundleIdentifier
                  "versions": [version_entry]
              }

              output["apps"].append(app_entry)
              processed_count += 1

          # Save output
          with open("sidestore-source.json", "w") as f:
              json.dump(output, f, indent=2, ensure_ascii=False)
          print(f"‚úÖ Generated {len(output['apps']} apps")
          EOF

      - name: Validate JSON
        run: |
          sudo apt-get install -y jq
          
          # Basic validation
          if ! jq empty sidestore-source.json; then
            echo "‚ùå Invalid JSON structure"
            exit 1
          fi

          # Check for exactly 10 apps
          APP_COUNT=$(jq '.apps | length' sidestore-source.json)
          if [ "$APP_COUNT" -ne 10 ]; then
            echo "‚ùå Expected 10 apps, got $APP_COUNT"
            exit 1
          fi

          echo "‚úÖ Validated 10 apps successfully"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sidestore-source.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Auto-update: 10 apps - $(date +'%Y-%m-%d %H:%M')"
          git push
